# Plan Configuration Multi-Niveaux - hexa CLI

## Vue d'ensemble

Syst√®me de configuration hi√©rarchique avec installation/upgrade automatique via Homebrew, bas√© sur Viper avec `MergeConfig()`.

## Architecture de Configuration

### Hi√©rarchie (sp√©cifique override global)

```
1. ~/.hexa.yml              (global user)
2. ~/Code/project/.hexa.yml (project-specific) ‚Üê override
3. ./hexa.yml               (current directory) ‚Üê override
4. ENV variables            (runtime) ‚Üê override
5. Command line flags       (runtime) ‚Üê override
```

**Principe** : Plus sp√©cifique = plus prioritaire, merge automatique.

### Support Natif Viper

```go
// Configuration multi-niveaux avec MergeConfig()
func loadConfig() error {
    viper.SetConfigType("yaml")

    // 1. Base : global config (~/.hexa.yml)
    if homeConfig, err := os.ReadFile(filepath.Join(home, ".hexa.yml")); err == nil {
        viper.ReadConfig(bytes.NewBuffer(homeConfig))
    }

    // 2. Override : project config (remont√©e vers ~/)
    projectPath := findProjectConfig() // cherche .hexa.yml jusqu'√† ~/
    if projectConfig, err := os.ReadFile(projectPath); err == nil {
        viper.MergeConfig(bytes.NewBuffer(projectConfig)) // ‚Üê Merge avec pr√©c√©dence
    }

    // 3. Override : current dir (./hexa.yml)
    if currentConfig, err := os.ReadFile("./hexa.yml"); err == nil {
        viper.MergeConfig(bytes.NewBuffer(currentConfig))
    }

    // 4. ENV variables automatiques (HEXA_JIRA_URL, etc.)
    viper.AutomaticEnv()
    viper.SetEnvPrefix("HEXA")
    viper.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))

    return nil
}
```

### Recherche de Configuration Projet

```go
// Remonte depuis PWD jusqu'√† home pour trouver .hexa.yml
func findProjectConfig() string {
    dir, _ := os.Getwd()
    home, _ := os.UserHomeDir()

    for dir != home && dir != "/" {
        configPath := filepath.Join(dir, ".hexa.yml")
        if _, err := os.Stat(configPath); err == nil {
            return configPath
        }
        dir = filepath.Dir(dir)
    }
    return ""
}
```

## Installation et Upgrade Automatique

### Strat√©gie : Version-based + Homebrew Hook

```go
const CONFIG_VERSION = "1.0.0"

func ensureConfigUpToDate() error {
    homeDir, _ := os.UserHomeDir()
    configPath := filepath.Join(homeDir, ".hexa.yml")

    // Lire config existante pour check version
    if data, err := os.ReadFile(configPath); err == nil {
        if !strings.Contains(string(data), CONFIG_VERSION) {
            fmt.Printf("üîÑ Updating config to v%s...\n", CONFIG_VERSION)
            return createOrUpgradeConfig(configPath)
        }
        return nil // Config √† jour
    }

    // Pas de config = premi√®re install
    fmt.Println("üéØ Installing default config...")
    return createOrUpgradeConfig(configPath)
}
```

### Homebrew Formula avec Post-Install Hook

```ruby
class Hexa < Formula
  desc "Unified CLI for development workflows"
  homepage "https://github.com/hyphaene/hexa"
  url "https://github.com/hyphaene/hexa/releases/download/v1.0.0/hexa_Darwin_x86_64.tar.gz"

  def install
    bin.install "hexa"
    bin.install_symlink "hexa" => "hw"
  end

  def post_install
    # Setup default config si inexistant ou upgrade si n√©cessaire
    system bin/"hexa", "config", "init", "--if-missing"
  end
end
```

### Template Configuration Embarqu√©

```go
//go:embed templates/hexa-template.yml
var defaultConfigTemplate []byte

func createOrUpgradeConfig(configPath string) error {
    // Remplacer les placeholders
    template := string(defaultConfigTemplate)
    template = strings.ReplaceAll(template, "${USER_EMAIL}", getUserEmail())
    template = strings.ReplaceAll(template, "${HOME}", os.Getenv("HOME"))
    template = strings.ReplaceAll(template, "${CONFIG_VERSION}", CONFIG_VERSION)

    return os.WriteFile(configPath, []byte(template), 0644)
}
```

## Structure du Template par D√©faut

**templates/hexa-template.yml** :

```yaml
# Generated by hexa v${CONFIG_VERSION} - Configuration Template
# Edit this file to customize your hexa configuration
# Version: ${CONFIG_VERSION}

jira:
  url: "https://your-jira-instance.com"
  token: "${HEXA_JIRA_PAT}" # Set your JIRA_PAT environment variable
  default_project: "YOUR_PROJECT"
  timeout: 30
  retry: 3

git:
  default_branch: "main"
  worktree_base: "${HOME}/worktrees"
  auto_push: false

slack:
  webhook_url: "${SLACK_WEBHOOK_URL}"

user:
  me: "${HEXA_USER_EMAIL}" # Auto-detected from git config

# Aliases for common commands
aliases:
  overview: "jira sprint overview --user me"
  setup: "jira dev setup"
  comment: "jira ticket comment"
  move: "jira ticket move"
  daily: ["jira sprint overview --user me", "git repo status"]
  wip: "jira ticket move {ticket} --status 'In Progress' && jira ticket comment {ticket} 'Work in progress'"
# Advanced: project-specific configs can override these values
# Create ~/Code/project/.hexa.yml for project-specific settings
```

## Exemples de Configuration Multi-Niveaux

### Configuration Globale (~/.hexa.yml)

```yaml
# Version: 1.0.0
jira:
  url: "https://jira.company.com"
  token: "${JIRA_PAT}"
  default_project: "GLOBAL"
  timeout: 30
  retry: 3

git:
  default_branch: "main"
  worktree_base: "~/worktrees"
  auto_push: false

user:
  me: "maximilien.garenne@company.com"
```

### Configuration Projet (~/Code/specific-project/.hexa.yml)

```yaml
# Override partiel - merge automatique avec global
jira:
  default_project: "PROJ" # ‚Üê Override seulement √ßa
  timeout: 60 # ‚Üê Override seulement √ßa
  # url, token, retry ‚Üí h√©rit√©es de global !

git:
  default_branch: "develop" # ‚Üê Override seulement √ßa
  worktree_base: "./local-worktrees" # ‚Üê Override seulement √ßa
  # auto_push ‚Üí h√©rit√© de global !

# Config sp√©cifique au projet
database:
  host: "localhost"
  port: 5432
```

### R√©sultat Final Merg√©

```yaml
jira:
  url: "https://jira.company.com" # ‚Üê de global
  token: "${JIRA_PAT}" # ‚Üê de global
  default_project: "PROJ" # ‚Üê de project
  timeout: 60 # ‚Üê de project
  retry: 3 # ‚Üê de global

git:
  default_branch: "develop" # ‚Üê de project
  worktree_base: "./local-worktrees" # ‚Üê de project
  auto_push: false # ‚Üê de global

database: # ‚Üê de project uniquement
  host: "localhost"
  port: 5432

user:
  me: "maximilien.garenne@company.com" # ‚Üê de global
```

## Variables d'Environnement

### Support Natif Automatique

```go
// Configuration automatique
viper.AutomaticEnv()
viper.SetEnvPrefix("HEXA")
viper.SetEnvKeyReplacer(strings.NewReplacer(".", "_"))
```

### Exemples d'Usage

```bash
# Override √† l'ex√©cution
HEXA_JIRA_URL="https://jira.dev.com" hexa jira sprint overview
export HEXA_GIT_DEFAULT_BRANCH="feature-branch"
hexa git repo status

# Mapping automatique :
# jira.url        ‚Üí HEXA_JIRA_URL
# git.default_branch ‚Üí HEXA_GIT_DEFAULT_BRANCH
```

## Commandes de Configuration

### Commande `hexa config`

```bash
# Installation/upgrade manuel
hexa config init                    # Interactive setup
hexa config init --force            # Override existing
hexa config init --if-missing       # Only if missing (Homebrew hook)

# Gestion
hexa config show                    # Show effective config (merged)
hexa config show --global           # Show global config only
hexa config show --project          # Show project config only
hexa config validate                # Validate config syntax

# Edition
hexa config edit                    # Open in $EDITOR
hexa config edit --global           # Edit global config
hexa config edit --project          # Edit/create project config
```

### Int√©gration Cobra

```go
func init() {
    cobra.OnInitialize(initConfig)

    // Commandes config
    configCmd := &cobra.Command{
        Use:   "config",
        Short: "Manage hexa configuration",
    }

    configCmd.AddCommand(&cobra.Command{
        Use:   "init",
        Short: "Initialize or upgrade configuration",
        RunE:  initConfigCmd,
    })

    rootCmd.AddCommand(configCmd)
}

func initConfig() {
    ensureConfigUpToDate()  // Check version + upgrade si n√©cessaire
    loadConfig()            // Load multi-level config
}
```

## Flow d'Installation

### Premi√®re Installation

```bash
# 1. Installation via Homebrew
brew install hyphaene/hexa/hexa

# 2. Post-install hook automatique
# ‚Üí hexa config init --if-missing
# ‚Üí ~/.hexa.yml cr√©√© avec template

# 3. Usage imm√©diat
hexa version
hexa jira sprint overview  # Utilise config par d√©faut
```

### Upgrade Existant

```bash
# 1. Upgrade via Homebrew
brew upgrade hexa

# 2. Post-install hook automatique
# ‚Üí hexa config init --if-missing
# ‚Üí Check version dans ~/.hexa.yml
# ‚Üí Upgrade si n√©cessaire (pr√©serve customizations)

# 3. Nouvelles features disponibles
hexa config show  # Voir config effective merg√©e
```

## Avantages

### ‚úÖ **Ce qu'on gagne**

1. **Installation z√©ro-config** : Template automatique via Homebrew
2. **Upgrade sans casse** : Version-based upgrade pr√©serve les customizations
3. **Merge intelligent** : Override granulaire, pas besoin de tout red√©finir
4. **Env override** : Runtime flexibility avec HEXA\_\* variables
5. **Project isolation** : Config sp√©cifique par projet sans duplication
6. **Validation** : Syntax check et config effective visible

### üîß **Pattern Standards**

- **Viper MergeConfig()** : Support natif multi-niveaux
- **embed templates** : Config template dans binaire
- **Homebrew post_install** : Installation automatique
- **Version-based upgrade** : Migration config douce

## Next Steps

1. **Impl√©menter** `findProjectConfig()` et `loadConfig()`
2. **Cr√©er** template `templates/hexa-template.yml`
3. **Ajouter** commande `hexa config init`
4. **Configurer** GoReleaser pour Homebrew avec post_install hook
5. **Tester** flow complet install ‚Üí upgrade ‚Üí project override
